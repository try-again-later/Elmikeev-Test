import{u as W,B as D,c as T}from"./VSelect-2yHYKq4-.js";import{a as de,u as x}from"./useNProgress-CD9aLZ-6.js";import{a1 as y,a3 as v,a4 as m,d as pe,ap as b,a8 as F,a9 as k,at as f,ah as X,au as me,A as C,q as p,I as w,_,c as d,a7 as O,aq as g,a5 as h,M as S,h as o,a6 as A}from"./index-CUBrpC2I.js";import{o as Y}from"./list-CwxKENw3.js";function E(s,t,r){return de(s,-t,r)}const j=y({__name:"PercentageChange",props:{change:{}},setup(s){return(t,r)=>(m(),v("span",{class:pe({"text-red":t.change<0,"text-green":t.change>0})},[b(f((t.change*100).toFixed(0))+"% ",1),t.change>0?(m(),F(X,{key:0,icon:"mdi-arrow-top-right"})):t.change<0?(m(),F(X,{key:1,icon:"mdi-arrow-bottom-right"})):k("",!0)],2))}});function L(s){const t={};for(const r of s)r.nm_id in t?t[r.nm_id]+=1:t[r.nm_id]=1;return t}function ge(s){const t=L(s),r=Object.keys(t).map(a=>({partName:a,count:t[a]}));return r.sort((a,c)=>c.count-a.count),r}function he(s,t){const r=L(s),a=L(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)e in r&&e in a&&i.push({partName:e,previousOrderCount:r[e],currentOrderCount:a[e],change:(a[e]-r[e])/r[e]||0});return i.sort((e,n)=>n.change-e.change),i}const B=me("orderPeriodChanges",()=>{const s=C(E(new Date,7)),t=C(new Date),r=C(E(new Date,15)),a=C(E(new Date,8)),c=p(()=>Y({dateFrom:s.value,dateTo:t.value,page:1,limit:500}).href),{execute:i,isFetching:e,error:n,data:P}=W(c,{refetch:!0}).get().json(),u=p(()=>P.value==null?[]:P.value.data),Z=p(()=>Y({dateFrom:r.value,dateTo:a.value,page:1,limit:500}).href),{execute:ee,isFetching:te,error:re,data:z}=W(Z,{refetch:!0}).get().json(),N=p(()=>z.value==null?[]:z.value.data),M=C(!1);w(()=>{M.value=e.value||te.value});const ne=p(()=>n.value!=null||re.value!=null),ae=()=>{i(),ee()},oe=p(()=>[...new Set([...N.value.map(l=>l.nm_id),...u.value.map(l=>l.nm_id)])]),$=C([]),G=l=>$.value.length==0||$.value.includes(l.nm_id),se=p(()=>[...new Set([...N.value.map(l=>l.category),...u.value.map(l=>l.category)])]),H=C([]),J=l=>H.value.length==0||H.value.includes(l.category),le=p(()=>[...new Set([...N.value.map(l=>l.brand),...u.value.map(l=>l.brand)])]),R=C([]),K=l=>R.value.length==0||R.value.includes(l.brand),ue=p(()=>[...new Set([...N.value.map(l=>l.oblast),...u.value.map(l=>l.oblast)])]),V=C([]),Q=l=>V.value.length==0||V.value.includes(l.oblast),ie=p(()=>u.value.filter(l=>G(l)&&J(l)&&K(l)&&Q(l))),ce=p(()=>N.value.filter(l=>G(l)&&J(l)&&K(l)&&Q(l)));return{currentPeriodDateFrom:s,currentPeriodDateTo:t,previousPeriodDateFrom:r,previousPeriodDateTo:a,isFetching:M,hasError:ne,retry:ae,currentPeriodOrders:ie,previousPeriodOrders:ce,allPartNames:oe,partNamesFilter:$,allCategories:se,categoryFilter:H,allBrands:le,brandFilter:R,allRegions:ue,regionFilter:V}}),ke=y({__name:"OrderSales",props:{showFullTable:{type:Boolean}},setup(s){const t=B(),{isLoading:r}=x();w(()=>{r.value=t.isFetching});const a=p(()=>{let e=he(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c=p(()=>{const e=ge(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.count),label:"Количество продаж по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}}),i={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}};return(e,n)=>{const P=j;return m(),v(_,null,[d(O,{class:"position-relative w-100",height:g(c).maxHeight,"min-height":200},{default:h(()=>[d(g(D),{data:g(c),options:i,onClick:n[0]||(n[0]=u=>e.$router.push({path:"/order-changes/sales",replace:!0}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?k("",!0):(m(),F(S,{key:0,variant:"outlined",class:"my-4",to:{path:"/order-changes/sales",replace:!0}},{default:h(()=>n[1]||(n[1]=[b(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:h(()=>n[2]||(n[2]=[b("Топ 20 изменений по продажам:")])),_:1,__:[2]}),d(T,null,{default:h(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Количество продаж в предыдущем периоде"),o("th",null,"Количество продаж в текущем периоде"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(m(!0),v(_,null,A(g(a),u=>(m(),v("tr",null,[o("td",null,f(u.partName),1),o("td",null,f(u.previousOrderCount),1),o("td",null,f(u.currentOrderCount),1),o("td",null,[d(P,{change:u.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});function I(s){const t={};for(const r of s)r.nm_id in t?t[r.nm_id]+=Number.parseFloat(r.total_price)||0:t[r.nm_id]=Number.parseFloat(r.total_price)||0;return t}function Pe(s){const t=I(s),r=Object.keys(t).map(a=>({partName:a,totalPrice:t[a]}));return r.sort((a,c)=>c.totalPrice-a.totalPrice),r}function ve(s,t){const r=I(s),a=I(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)e in r&&e in a&&i.push({partName:e,previousTotalPrice:r[e],currentTotalPrice:a[e],change:(a[e]-r[e])/r[e]||0});return i.sort((e,n)=>n.change-e.change),i}const we=y({__name:"OrderPrices",props:{showFullTable:{type:Boolean}},setup(s){const t=B(),{isLoading:r}=x();w(()=>{r.value=t.isFetching});const a=p(()=>{let e=ve(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}},i=p(()=>{const e=Pe(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.totalPrice),label:"Суммарная стоимость продаж по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}});return(e,n)=>{const P=j;return m(),v(_,null,[d(O,{class:"position-relative w-100",height:g(i).maxHeight,"min-height":200},{default:h(()=>[d(g(D),{data:g(i),options:c,onClick:n[0]||(n[0]=u=>e.$router.push({path:"/order-changes/prices",replace:!0}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?k("",!0):(m(),F(S,{key:0,variant:"outlined",class:"my-4",to:{path:"/order-changes/prices",replace:!0}},{default:h(()=>n[1]||(n[1]=[b(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:h(()=>n[2]||(n[2]=[b(" Топ 20 изменений по суммарной стоимости продаж: ")])),_:1,__:[2]}),d(T,null,{default:h(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Сумма за предыдущий период"),o("th",null,"Сумма за текущий период"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(m(!0),v(_,null,A(g(a),u=>(m(),v("tr",null,[o("td",null,f(u.partName),1),o("td",null,f(u.previousTotalPrice.toFixed(2)),1),o("td",null,f(u.currentTotalPrice.toFixed(2)),1),o("td",null,[d(P,{change:u.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});function q(s){const t={};for(const r of s)r.is_cancel&&(r.nm_id in t?t[r.nm_id]+=1:t[r.nm_id]=1);return t}function fe(s){const t=q(s),r=Object.keys(t).map(a=>({partName:a,cancelCount:t[a]}));return r.sort((a,c)=>c.cancelCount-a.cancelCount),r}function Ce(s,t){const r=q(s),a=q(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)e in r&&e in a&&i.push({partName:e,previousCancelCount:r[e],currentCancelCount:a[e],change:(a[e]-r[e])/r[e]||0});return i.sort((e,n)=>n.change-e.change),i}const De=y({__name:"OrderCancels",props:{showFullTable:{type:Boolean}},setup(s){const t=B(),{isLoading:r}=x();w(()=>{r.value=t.isFetching});const a=p(()=>{let e=Ce(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}},i=p(()=>{const e=fe(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.cancelCount),label:"Количество отмен по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}});return(e,n)=>{const P=j;return m(),v(_,null,[d(O,{class:"position-relative w-100",height:g(i).maxHeight,"min-height":200},{default:h(()=>[d(g(D),{data:g(i),options:c,onClick:n[0]||(n[0]=u=>e.$router.push({path:"/order-changes/cancels",replace:!0}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?k("",!0):(m(),F(S,{key:0,variant:"outlined",class:"my-4",to:{path:"/order-changes/cancels",replace:!0}},{default:h(()=>n[1]||(n[1]=[b(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:h(()=>n[2]||(n[2]=[b(" Топ 20 изменений по количеству отмен: ")])),_:1,__:[2]}),d(T,null,{default:h(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Отмен за предыдущий период"),o("th",null,"Отмен за текущий период"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(m(!0),v(_,null,A(g(a),u=>(m(),v("tr",null,[o("td",null,f(u.partName),1),o("td",null,f(u.previousCancelCount),1),o("td",null,f(u.currentCancelCount),1),o("td",null,[d(P,{change:u.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});function U(s){const t={};for(const r of s)r.nm_id in t?(t[r.nm_id].count+=1,t[r.nm_id].discountSum+=r.discount_percent):t[r.nm_id]={count:1,discountSum:r.discount_percent};return t}function be(s){const t=U(s),r=Object.keys(t).map(a=>({partName:a,averageDiscount:t[a].discountSum/t[a].count}));return r.sort((a,c)=>c.averageDiscount-a.averageDiscount),r}function _e(s,t){const r=U(s),a=U(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)if(e in r&&e in a){const n=r[e].discountSum/r[e].count,P=a[e].discountSum/a[e].count;i.push({partName:e,previousAverageDiscount:n,currentAverageDiscount:P,change:(P-n)/n||0})}return i.sort((e,n)=>n.change-e.change),i}const Te=y({__name:"OrderAverageDiscounts",props:{showFullTable:{type:Boolean}},setup(s){const t=B(),{isLoading:r}=x();w(()=>{r.value=t.isFetching});const a=p(()=>{let e=_e(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}},i=p(()=>{const e=be(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.averageDiscount),label:"Средняя скидка по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}});return(e,n)=>{const P=j;return m(),v(_,null,[d(O,{class:"position-relative w-100",height:g(i).maxHeight,"min-height":200},{default:h(()=>[d(g(D),{data:g(i),options:c,onClick:n[0]||(n[0]=u=>e.$router.push({path:"/order-changes/average-discounts",replace:!0}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?k("",!0):(m(),F(S,{key:0,variant:"outlined",class:"my-4",to:{path:"/order-changes/average-discounts",replace:!0}},{default:h(()=>n[1]||(n[1]=[b(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:h(()=>n[2]||(n[2]=[b(" Топ 20 изменений по средней скидке: ")])),_:1,__:[2]}),d(T,null,{default:h(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Средняя скидка за предыдущий период"),o("th",null,"Средняя скидка за текущий период"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(m(!0),v(_,null,A(g(a),u=>(m(),v("tr",null,[o("td",null,f(u.partName),1),o("td",null,f(u.previousAverageDiscount.toFixed(2)),1),o("td",null,f(u.currentAverageDiscount.toFixed(2)),1),o("td",null,[d(P,{change:u.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});export{ke as _,we as a,De as b,Te as c,B as u};
