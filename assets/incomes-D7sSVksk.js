import{d as M,u as R,a as Z,B as G,V as x,b as P,c as H,e as J,f as K}from"./VTable-B37YhKEG.js";import{u as O,s as X,a as ee}from"./useNProgress-OwaJ0D9o.js";import{u as ae}from"./incomeFilters-XDcimTxl.js";import{a1 as le,C as h,q as w,A as F,I as te,a2 as ue,a3 as q,a4 as c,h as t,c as u,a8 as ne,a9 as _,a5 as s,ab as o,a7 as E,ac as k,ad as $,ae as A,M as se,_ as T,a6 as oe,af as V}from"./index-CmRbzJfx.js";import{V as de}from"./VRangeSlider-DUSKCKAU.js";import"./VList-Bc26kmH8.js";import"./format-DkDJ03km.js";function re(y){const d=new URL("https://elmikeev.185-236-23-37.sslip.io/api/incomes");return d.searchParams.append("dateFrom",M(y.dateFrom)),d.searchParams.append("dateTo",M(y.dateTo)),d.searchParams.append("page",y.page.toString()),d.searchParams.append("limit",y.limit.toString()),d.searchParams.append("key","E6kUTYrYwZq2tN4QEtyzsbEBk3ie"),d}const ie={class:"text-center"},ce=le({__name:"incomes",setup(y){const d=ae(),{dateFrom:p,dateTo:v}=O(),i=R("page","1",{transform:Number});h(p,()=>{i.value=1}),h(v,()=>{i.value=1});const L=X(new Date),Q=new Date,I=w(()=>re({dateFrom:p.value??L,dateTo:v.value??Q,page:i.value,limit:100}).href),{execute:Y,isFetching:j,error:U,data:b}=Z(I,{refetch:!0}).get().json(),{isLoading:z}=ee();h(j,l=>{z.value=l});const S=F(0),f=F(0),D=R("quantity-range",null),n=w({get(){return D.value==null?[S.value,f.value]:D.value.split(",").map(l=>Number.parseFloat(l)||0).slice(0,2)},set(l){D.value=`${l[0]},${l[1]}`}}),C=F([]),m=F([]);te(()=>{d.dateFrom=p.value,d.dateTo=v.value,d.page=i.value,d.quantityRange=n.value}),h(b,l=>{if(l!=null){const e=n.value[1]==f.value;S.value=0,f.value=Math.max(Math.ceil(l.data.reduce((r,g)=>Math.max(r,g.quantity),0)),f.value),(n.value[1]==0||e)&&(n.value[1]=f.value),C.value=[...new Set([...l.data.map(r=>r.nm_id)])],m.value=[]}});const N=w(()=>b.value==null?[]:b.value.data.filter(l=>n.value[0]<=l.quantity&&l.quantity<=n.value[1]&&(m.value.length==0||m.value.length>0&&m.value.includes(l.nm_id)))),W=w(()=>{const l=[...new Set(N.value.map(r=>r.warehouse_name))],e=[];for(const r of l){const g=N.value.reduce((a,B)=>(B.warehouse_name==r?B.quantity:0)+a,0);e.push(g)}return{labels:l,datasets:[{data:e,label:"Суммарное количество в каждом складе",backgroundColor:"rgb(255, 99, 132)"}]}});return(l,e)=>{var g;const r=ue("v-date-input");return c(),q(T,null,[e[15]||(e[15]=t("h1",{class:"mb-8"},"Доходы",-1)),u(E,{class:"position-relative",height:"500"},{default:s(()=>[u(o(G),{data:W.value,options:{responsive:!0,maintainAspectRatio:!1}},null,8,["data"])]),_:1}),u(P,null,{default:s(()=>[u(x,{cols:"12",sm:"6"},{default:s(()=>[u(r,{label:"Начиная с даты",modelValue:o(p),"onUpdate:modelValue":e[0]||(e[0]=a=>k(p)?p.value=a:null)},null,8,["modelValue"])]),_:1}),u(x,{cols:"12",sm:"6"},{default:s(()=>[u(r,{label:"Заканчивая датой",modelValue:o(v),"onUpdate:modelValue":e[1]||(e[1]=a=>k(v)?v.value=a:null)},null,8,["modelValue"])]),_:1})]),_:1}),u(P,null,{default:s(()=>[u(x,{cols:"12",md:"1",class:"d-flex align-center"},{default:s(()=>e[7]||(e[7]=[$("Фильтр по количеству:")])),_:1,__:[7]}),u(x,null,{default:s(()=>[u(de,{modelValue:n.value,"onUpdate:modelValue":e[4]||(e[4]=a=>n.value=a),max:o(f),min:o(S),step:1,class:"align-center","hide-details":""},{prepend:s(()=>[u(A,{modelValue:n.value[0],"onUpdate:modelValue":e[2]||(e[2]=a=>n.value[0]=a),density:"compact",style:{width:"100px"},type:"number",variant:"outlined","hide-details":"","single-line":""},null,8,["modelValue"])]),append:s(()=>[u(A,{modelValue:n.value[1],"onUpdate:modelValue":e[3]||(e[3]=a=>n.value[1]=a),density:"compact",style:{width:"100px"},type:"number",variant:"outlined","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1},8,["modelValue","max","min"])]),_:1})]),_:1}),o(U)!=null?(c(),ne(E,{key:0,class:"d-flex flex-column ga-4 align-center"},{default:s(()=>[e[9]||(e[9]=t("p",null,"Ошибка при загрузке данных",-1)),u(se,{onClick:o(Y)},{default:s(()=>e[8]||(e[8]=[$("Попробовать ещё раз")])),_:1,__:[8]},8,["onClick"])]),_:1,__:[9]})):_("",!0),o(U)==null?(c(),q(T,{key:1},[u(J,{"fixed-header":"",striped:"even",class:"mt-8"},{default:s(()=>[t("thead",null,[t("tr",null,[t("th",null,[u(H,{modelValue:o(m),"onUpdate:modelValue":e[5]||(e[5]=a=>k(m)?m.value=a:null),items:o(C),"max-width":"250",label:"Артикул",multiple:""},null,8,["modelValue","items"])]),e[10]||(e[10]=t("th",null,"Штрих-код",-1)),e[11]||(e[11]=t("th",null,"Дата",-1)),e[12]||(e[12]=t("th",null,"Дата закрытия",-1)),e[13]||(e[13]=t("th",null,"Количество",-1)),e[14]||(e[14]=t("th",null,"Склад",-1))])]),t("tbody",null,[(c(!0),q(T,null,oe(N.value,a=>(c(),q("tr",null,[t("td",null,V(a.nm_id),1),t("td",null,V(a.barcode),1),t("td",null,V(a.date),1),t("td",null,V(a.date_close),1),t("td",null,V(a.quantity),1),t("td",null,V(a.warehouse_name),1)]))),256))])]),_:1}),t("div",ie,[u(K,{modelValue:o(i),"onUpdate:modelValue":e[6]||(e[6]=a=>k(i)?i.value=a:null),length:(g=o(b))==null?void 0:g.meta.last_page,density:l.$vuetify.display.smAndDown?"compact":"default","total-visible":l.$vuetify.display.smAndDown?2:5},null,8,["modelValue","length","density","total-visible"])])],64)):_("",!0)],64)}}});export{ce as default};
