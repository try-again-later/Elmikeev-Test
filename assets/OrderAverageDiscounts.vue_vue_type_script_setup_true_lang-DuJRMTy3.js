import{u as W,B as x,c as T}from"./VSelect-DF19_I_i.js";import{a as de,u as S}from"./useNProgress-BlMZuria.js";import{a1 as y,a3 as v,a4 as h,d as pe,ap as f,a8 as F,a9 as w,at as C,ah as X,au as me,A as _,q as m,I as D,_ as b,c as d,a7 as O,aq as g,a5 as p,M as N,h as o,a6 as A}from"./index-CzFrGEAC.js";import{o as Y}from"./list-C1eeSAeY.js";function V(s,t,r){return de(s,-t,r)}const $=y({__name:"PercentageChange",props:{change:{}},setup(s){return(t,r)=>(h(),v("span",{class:pe({"text-red":t.change<0,"text-green":t.change>0})},[f(C((t.change*100).toFixed(0))+"% ",1),t.change>0?(h(),F(X,{key:0,icon:"mdi-arrow-top-right"})):t.change<0?(h(),F(X,{key:1,icon:"mdi-arrow-bottom-right"})):w("",!0)],2))}});function E(s){const t={};for(const r of s)r.nm_id in t?t[r.nm_id]+=1:t[r.nm_id]=1;return t}function he(s){const t=E(s),r=Object.keys(t).map(a=>({partName:a,count:t[a]}));return r.sort((a,c)=>c.count-a.count),r}function ge(s,t){const r=E(s),a=E(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)e in r&&e in a&&i.push({partName:e,previousOrderCount:r[e],currentOrderCount:a[e],change:(a[e]-r[e])/r[e]||0});return i.sort((e,n)=>n.change-e.change),i}const j=me("orderPeriodChanges",()=>{const s=_(V(new Date,7)),t=_(new Date),r=_(V(new Date,15)),a=_(V(new Date,8)),c=m(()=>Y({dateFrom:s.value,dateTo:t.value,page:1,limit:500}).href),{execute:i,isFetching:e,error:n,data:P}=W(c,{refetch:!0}).get().json(),l=m(()=>P.value==null?[]:P.value.data),Z=m(()=>Y({dateFrom:r.value,dateTo:a.value,page:1,limit:500}).href),{execute:ee,isFetching:te,error:re,data:U}=W(Z,{refetch:!0}).get().json(),k=m(()=>U.value==null?[]:U.value.data),M=_(!1);D(()=>{M.value=e.value||te.value});const ne=m(()=>n.value!=null||re.value!=null),ae=()=>{i(),ee()},oe=m(()=>[...new Set([...k.value.map(u=>u.nm_id),...l.value.map(u=>u.nm_id)])]),B=_([]),G=u=>B.value.length==0||B.value.includes(u.nm_id),se=m(()=>[...new Set([...k.value.map(u=>u.category),...l.value.map(u=>u.category)])]),z=_([]),J=u=>z.value.length==0||z.value.includes(u.category),le=m(()=>[...new Set([...k.value.map(u=>u.brand),...l.value.map(u=>u.brand)])]),H=_([]),K=u=>H.value.length==0||H.value.includes(u.brand),ue=m(()=>[...new Set([...k.value.map(u=>u.oblast),...l.value.map(u=>u.oblast)])]),R=_([]),Q=u=>R.value.length==0||R.value.includes(u.oblast),ie=m(()=>l.value.filter(u=>G(u)&&J(u)&&K(u)&&Q(u))),ce=m(()=>k.value.filter(u=>G(u)&&J(u)&&K(u)&&Q(u)));return{currentPeriodDateFrom:s,currentPeriodDateTo:t,previousPeriodDateFrom:r,previousPeriodDateTo:a,isFetching:M,hasError:ne,retry:ae,currentPeriodOrders:ie,previousPeriodOrders:ce,allPartNames:oe,partNamesFilter:B,allCategories:se,categoryFilter:z,allBrands:le,brandFilter:H,allRegions:ue,regionFilter:R}}),ye=y({__name:"OrderSales",props:{showFullTable:{type:Boolean}},setup(s){const t=j(),{isLoading:r}=S();D(()=>{r.value=t.isFetching});const a=m(()=>{let e=ge(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c=m(()=>{const e=he(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.count),label:"Количество продаж по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}}),i={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}};return(e,n)=>{const P=$;return h(),v(b,null,[d(O,{class:"position-relative w-100",height:g(c).maxHeight,"min-height":200},{default:p(()=>[d(g(x),{data:g(c),options:i,onClick:n[0]||(n[0]=l=>e.$router.push({path:"/order-changes/sales"}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?w("",!0):(h(),F(N,{key:0,variant:"outlined",size:"x-small",class:"my-4",to:{path:"/order-changes/sales"}},{default:p(()=>n[1]||(n[1]=[f(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:p(()=>n[2]||(n[2]=[f("Топ 20 изменений по продажам:")])),_:1,__:[2]}),d(T,null,{default:p(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Количество продаж в предыдущем периоде"),o("th",null,"Количество продаж в текущем периоде"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(h(!0),v(b,null,A(g(a),l=>(h(),v("tr",null,[o("td",null,[d(N,{variant:"tonal",size:"small",to:{path:`/order/${l.partName}`}},{default:p(()=>[f(C(l.partName),1)]),_:2},1032,["to"])]),o("td",null,C(l.previousOrderCount),1),o("td",null,C(l.currentOrderCount),1),o("td",null,[d(P,{change:l.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});function L(s){const t={};for(const r of s)r.nm_id in t?t[r.nm_id]+=Number.parseFloat(r.total_price)||0:t[r.nm_id]=Number.parseFloat(r.total_price)||0;return t}function Pe(s){const t=L(s),r=Object.keys(t).map(a=>({partName:a,totalPrice:t[a]}));return r.sort((a,c)=>c.totalPrice-a.totalPrice),r}function ve(s,t){const r=L(s),a=L(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)e in r&&e in a&&i.push({partName:e,previousTotalPrice:r[e],currentTotalPrice:a[e],change:(a[e]-r[e])/r[e]||0});return i.sort((e,n)=>n.change-e.change),i}const we=y({__name:"OrderPrices",props:{showFullTable:{type:Boolean}},setup(s){const t=j(),{isLoading:r}=S();D(()=>{r.value=t.isFetching});const a=m(()=>{let e=ve(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}},i=m(()=>{const e=Pe(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.totalPrice),label:"Суммарная стоимость продаж по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}});return(e,n)=>{const P=$;return h(),v(b,null,[d(O,{class:"position-relative w-100",height:g(i).maxHeight,"min-height":200},{default:p(()=>[d(g(x),{data:g(i),options:c,onClick:n[0]||(n[0]=l=>e.$router.push({path:"/order-changes/prices"}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?w("",!0):(h(),F(N,{key:0,variant:"outlined",size:"x-small",class:"my-4",to:{path:"/order-changes/prices"}},{default:p(()=>n[1]||(n[1]=[f(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:p(()=>n[2]||(n[2]=[f(" Топ 20 изменений по суммарной стоимости продаж: ")])),_:1,__:[2]}),d(T,null,{default:p(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Сумма за предыдущий период"),o("th",null,"Сумма за текущий период"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(h(!0),v(b,null,A(g(a),l=>(h(),v("tr",null,[o("td",null,[d(N,{variant:"tonal",size:"small",to:{path:`/order/${l.partName}`}},{default:p(()=>[f(C(l.partName),1)]),_:2},1032,["to"])]),o("td",null,C(l.previousTotalPrice.toFixed(2)),1),o("td",null,C(l.currentTotalPrice.toFixed(2)),1),o("td",null,[d(P,{change:l.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});function I(s){const t={};for(const r of s)r.is_cancel&&(r.nm_id in t?t[r.nm_id]+=1:t[r.nm_id]=1);return t}function fe(s){const t=I(s),r=Object.keys(t).map(a=>({partName:a,cancelCount:t[a]}));return r.sort((a,c)=>c.cancelCount-a.cancelCount),r}function Ce(s,t){const r=I(s),a=I(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)e in r&&e in a&&i.push({partName:e,previousCancelCount:r[e],currentCancelCount:a[e],change:(a[e]-r[e])/r[e]||0});return i.sort((e,n)=>n.change-e.change),i}const De=y({__name:"OrderCancels",props:{showFullTable:{type:Boolean}},setup(s){const t=j(),{isLoading:r}=S();D(()=>{r.value=t.isFetching});const a=m(()=>{let e=Ce(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}},i=m(()=>{const e=fe(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.cancelCount),label:"Количество отмен по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}});return(e,n)=>{const P=$;return h(),v(b,null,[d(O,{class:"position-relative w-100",height:g(i).maxHeight,"min-height":200},{default:p(()=>[d(g(x),{data:g(i),options:c,onClick:n[0]||(n[0]=l=>e.$router.push({path:"/order-changes/cancels"}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?w("",!0):(h(),F(N,{key:0,variant:"outlined",size:"x-small",class:"my-4",to:{path:"/order-changes/cancels"}},{default:p(()=>n[1]||(n[1]=[f(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:p(()=>n[2]||(n[2]=[f(" Топ 20 изменений по количеству отмен: ")])),_:1,__:[2]}),d(T,null,{default:p(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Отмен за предыдущий период"),o("th",null,"Отмен за текущий период"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(h(!0),v(b,null,A(g(a),l=>(h(),v("tr",null,[o("td",null,[d(N,{variant:"tonal",size:"small",to:{path:`/order/${l.partName}`}},{default:p(()=>[f(C(l.partName),1)]),_:2},1032,["to"])]),o("td",null,C(l.previousCancelCount),1),o("td",null,C(l.currentCancelCount),1),o("td",null,[d(P,{change:l.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});function q(s){const t={};for(const r of s)r.nm_id in t?(t[r.nm_id].count+=1,t[r.nm_id].discountSum+=r.discount_percent):t[r.nm_id]={count:1,discountSum:r.discount_percent};return t}function _e(s){const t=q(s),r=Object.keys(t).map(a=>({partName:a,averageDiscount:t[a].discountSum/t[a].count}));return r.sort((a,c)=>c.averageDiscount-a.averageDiscount),r}function be(s,t){const r=q(s),a=q(t),c=new Set([...Object.keys(r),...Object.keys(a)]),i=[];for(const e of c)if(e in r&&e in a){const n=r[e].discountSum/r[e].count,P=a[e].discountSum/a[e].count;i.push({partName:e,previousAverageDiscount:n,currentAverageDiscount:P,change:(P-n)/n||0})}return i.sort((e,n)=>n.change-e.change),i}const xe=y({__name:"OrderAverageDiscounts",props:{showFullTable:{type:Boolean}},setup(s){const t=j(),{isLoading:r}=S();D(()=>{r.value=t.isFetching});const a=m(()=>{let e=be(t.previousPeriodOrders,t.currentPeriodOrders);return s.showFullTable||(e=e.slice(0,20)),e}),c={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}},i=m(()=>{const e=_e(t.currentPeriodOrders);return{labels:e.map(n=>n.partName),datasets:[{data:e.map(n=>n.averageDiscount),label:"Средняя скидка по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:e.length*20}});return(e,n)=>{const P=$;return h(),v(b,null,[d(O,{class:"position-relative w-100",height:g(i).maxHeight,"min-height":200},{default:p(()=>[d(g(x),{data:g(i),options:c,onClick:n[0]||(n[0]=l=>e.$router.push({path:"/order-changes/average-discounts"}))},null,8,["data"])]),_:1},8,["height"]),e.showFullTable?w("",!0):(h(),F(N,{key:0,variant:"outlined",size:"x-small",class:"my-4",to:{path:"/order-changes/average-discounts"}},{default:p(()=>n[1]||(n[1]=[f(" Перейти на страницу показателя ")])),_:1,__:[1]})),d(O,{class:"my-2"},{default:p(()=>n[2]||(n[2]=[f(" Топ 20 изменений по средней скидке: ")])),_:1,__:[2]}),d(T,null,{default:p(()=>[n[3]||(n[3]=o("thead",null,[o("tr",null,[o("th",null,"Артикул"),o("th",null,"Средняя скидка за предыдущий период"),o("th",null,"Средняя скидка за текущий период"),o("th",null,"Процент изменения")])],-1)),o("tbody",null,[(h(!0),v(b,null,A(g(a),l=>(h(),v("tr",null,[o("td",null,[d(N,{variant:"tonal",size:"small",to:{path:`/order/${l.partName}`}},{default:p(()=>[f(C(l.partName),1)]),_:2},1032,["to"])]),o("td",null,C(l.previousAverageDiscount.toFixed(2)),1),o("td",null,C(l.currentAverageDiscount.toFixed(2)),1),o("td",null,[d(P,{change:l.change},null,8,["change"])])]))),256))])]),_:1,__:[3]})],64)}}});export{ye as _,we as a,De as b,xe as c,j as u};
