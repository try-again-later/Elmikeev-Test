import{d as M,u as Z,B as G,V as w,a as R,b as H,c as J}from"./VSelect-2yHYKq4-.js";import{u as P,V as K}from"./VPagination-55QRB8l-.js";import{u as O,s as X}from"./useDateRangeQuery-CaPH3FM_.js";import{u as ee}from"./useNProgress-CD9aLZ-6.js";import{u as ae}from"./incomeFilters-DcjIzd69.js";import{a1 as le,C as x,q as F,A as h,I as te,a2 as ue,a3 as q,a4 as c,h as t,c as u,a8 as ne,a9 as _,a5 as o,aq as r,a7 as E,ar as k,ap as $,as as A,M as se,_ as T,a6 as oe,at as g}from"./index-CUBrpC2I.js";import{V as re}from"./VRangeSlider-S_J-o7WH.js";import"./VList-ChWKIetX.js";import"./format-B7jzoFho.js";import"./startOfDay-BPp-VCLh.js";function de(y){const n=new URL("https://elmikeev.185-236-23-37.sslip.io/api/incomes");return n.searchParams.append("dateFrom",M(y.dateFrom)),n.searchParams.append("dateTo",M(y.dateTo)),n.searchParams.append("page",y.page.toString()),n.searchParams.append("limit",y.limit.toString()),n.searchParams.append("key","E6kUTYrYwZq2tN4QEtyzsbEBk3ie"),n}const ie={class:"text-center"},xe=le({__name:"incomes",setup(y){const n=ae(),{dateFrom:p,dateTo:v}=O(),i=P("page","1",{transform:Number});x(p,()=>{i.value=1}),x(v,()=>{i.value=1});const L=X(new Date),Q=new Date,I=F(()=>de({dateFrom:p.value??L,dateTo:v.value??Q,page:i.value,limit:100}).href),{execute:Y,isFetching:j,error:U,data:b}=Z(I,{refetch:!0}).get().json(),{isLoading:z}=ee();x(j,l=>{z.value=l});const N=h(0),f=h(0),S=P("quantity-range",null),s=F({get(){return S.value==null?[N.value,f.value]:S.value.split(",").map(l=>Number.parseFloat(l)||0).slice(0,2)},set(l){S.value=`${l[0]},${l[1]}`}}),C=h([]),m=h(n.partNamesFilter);te(()=>{n.dateFrom=p.value,n.dateTo=v.value,n.page=i.value,n.quantityRange=s.value,n.partNamesFilter=m.value}),x(b,l=>{if(l!=null){const e=s.value[1]==f.value;N.value=0,f.value=Math.max(Math.ceil(l.data.reduce((d,V)=>Math.max(d,V.quantity),0)),f.value),(s.value[1]==0||e)&&(s.value[1]=f.value),C.value=[...new Set([...l.data.map(d=>d.nm_id),...m.value])]}});const D=F(()=>b.value==null?[]:b.value.data.filter(l=>s.value[0]<=l.quantity&&l.quantity<=s.value[1]&&(m.value.length==0||m.value.includes(l.nm_id)))),W=F(()=>{const l=[...new Set(D.value.map(d=>d.warehouse_name))],e=[];for(const d of l){const V=D.value.reduce((a,B)=>(B.warehouse_name==d?B.quantity:0)+a,0);e.push(V)}return{labels:l,datasets:[{data:e,label:"Суммарное количество в каждом складе",backgroundColor:"rgb(255, 99, 132)"}]}});return(l,e)=>{var V;const d=ue("v-date-input");return c(),q(T,null,[e[15]||(e[15]=t("h1",{class:"mb-8"},"Доходы",-1)),u(E,{class:"position-relative",height:"500"},{default:o(()=>[u(r(G),{data:W.value,options:{responsive:!0,maintainAspectRatio:!1}},null,8,["data"])]),_:1}),u(R,null,{default:o(()=>[u(w,{cols:"12",sm:"6"},{default:o(()=>[u(d,{label:"Начиная с даты",modelValue:r(p),"onUpdate:modelValue":e[0]||(e[0]=a=>k(p)?p.value=a:null)},null,8,["modelValue"])]),_:1}),u(w,{cols:"12",sm:"6"},{default:o(()=>[u(d,{label:"Заканчивая датой",modelValue:r(v),"onUpdate:modelValue":e[1]||(e[1]=a=>k(v)?v.value=a:null)},null,8,["modelValue"])]),_:1})]),_:1}),u(R,null,{default:o(()=>[u(w,{cols:"12",md:"1",class:"d-flex align-center"},{default:o(()=>e[7]||(e[7]=[$("Фильтр по количеству:")])),_:1,__:[7]}),u(w,null,{default:o(()=>[u(re,{modelValue:s.value,"onUpdate:modelValue":e[4]||(e[4]=a=>s.value=a),max:r(f),min:r(N),step:1,class:"align-center","hide-details":""},{prepend:o(()=>[u(A,{modelValue:s.value[0],"onUpdate:modelValue":e[2]||(e[2]=a=>s.value[0]=a),density:"compact",style:{width:"100px"},type:"number",variant:"outlined","hide-details":"","single-line":""},null,8,["modelValue"])]),append:o(()=>[u(A,{modelValue:s.value[1],"onUpdate:modelValue":e[3]||(e[3]=a=>s.value[1]=a),density:"compact",style:{width:"100px"},type:"number",variant:"outlined","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1},8,["modelValue","max","min"])]),_:1})]),_:1}),r(U)!=null?(c(),ne(E,{key:0,class:"d-flex flex-column ga-4 align-center"},{default:o(()=>[e[9]||(e[9]=t("p",null,"Ошибка при загрузке данных",-1)),u(se,{onClick:r(Y)},{default:o(()=>e[8]||(e[8]=[$("Попробовать ещё раз")])),_:1,__:[8]},8,["onClick"])]),_:1,__:[9]})):_("",!0),r(U)==null?(c(),q(T,{key:1},[u(J,{"fixed-header":"",striped:"even",class:"mt-8"},{default:o(()=>[t("thead",null,[t("tr",null,[t("th",null,[u(H,{modelValue:r(m),"onUpdate:modelValue":e[5]||(e[5]=a=>k(m)?m.value=a:null),items:r(C),"min-width":"200","max-width":"400",label:"Артикул",multiple:""},null,8,["modelValue","items"])]),e[10]||(e[10]=t("th",null,"Штрих-код",-1)),e[11]||(e[11]=t("th",null,"Дата",-1)),e[12]||(e[12]=t("th",null,"Дата закрытия",-1)),e[13]||(e[13]=t("th",null,"Количество",-1)),e[14]||(e[14]=t("th",null,"Склад",-1))])]),t("tbody",null,[(c(!0),q(T,null,oe(D.value,a=>(c(),q("tr",null,[t("td",null,g(a.nm_id),1),t("td",null,g(a.barcode),1),t("td",null,g(a.date),1),t("td",null,g(a.date_close),1),t("td",null,g(a.quantity),1),t("td",null,g(a.warehouse_name),1)]))),256))])]),_:1}),t("div",ie,[u(K,{modelValue:r(i),"onUpdate:modelValue":e[6]||(e[6]=a=>k(i)?i.value=a:null),length:(V=r(b))==null?void 0:V.meta.last_page,density:l.$vuetify.display.smAndDown?"compact":"default","total-visible":l.$vuetify.display.smAndDown?2:5},null,8,["modelValue","length","density","total-visible"])])],64)):_("",!0)],64)}}});export{xe as default};
