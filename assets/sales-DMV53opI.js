import{d as L,u as ee,V as S,a as Q,b as P,c as le}from"./VSelect-CoX54rQI.js";import{u as I}from"./index-CVG1nkrh.js";import{u as ae}from"./useNProgress-BhzykK6_.js";import{u as te,s as ue}from"./useDateRangeQuery-BZScIdAx.js";import{B as ne}from"./index-Bs4QrVmf.js";import{u as oe}from"./saleFilters-DRbVP7RD.js";import{a1 as re,C as U,q as k,A as i,I as se,a2 as de,a3 as D,a4 as h,h as t,c as u,a8 as ie,a9 as Y,a5 as d,aq as o,a7 as j,ar as c,ap as z,as as W,M as me,_ as M,a6 as pe,at as m}from"./index-CBPJuryY.js";import{V as ve}from"./VRangeSlider-BaOL0hCu.js";import{V as ge}from"./VPagination-BkBWmOM3.js";import"./VList-DPzMOoVM.js";import"./format-_sNi8qoz.js";import"./startOfDay-CTcnnNpE.js";function fe(w){const n=new URL("https://elmikeev.185-236-23-37.sslip.io/api/sales");return n.searchParams.append("dateFrom",L(w.dateFrom)),n.searchParams.append("dateTo",L(w.dateTo)),n.searchParams.append("page",w.page.toString()),n.searchParams.append("limit",w.limit.toString()),n.searchParams.append("key","E6kUTYrYwZq2tN4QEtyzsbEBk3ie"),n}const Ve={class:"text-center"},De=re({__name:"sales",setup(w){const n=oe(),{dateFrom:b,dateTo:F}=te(),p=I("page","1",{transform:Number});U(b,()=>{p.value=1}),U(F,()=>{p.value=1});const Z=ue(new Date),G=new Date,H=k(()=>fe({dateFrom:b.value??Z,dateTo:F.value??G,page:p.value,limit:100}).href),{execute:J,isFetching:K,error:_,data:N}=ee(H,{refetch:!0}).get().json(),{isLoading:O}=ae();U(K,a=>{O.value=a});const T=i(0),y=i(0),C=I("price-range",null),s=k({get(){return C.value==null?[T.value,y.value]:C.value.split(",").map(a=>Number.parseFloat(a)||0).slice(0,2)},set(a){C.value=`${a[0]},${a[1]}`}}),$=i([]),v=i(n.partNamesFilter),E=i([]),g=i(n.regionFilter),R=i([]),f=i(n.brandFilter),q=i([]),V=i(n.categoryFilter);se(()=>{n.dateFrom=b.value,n.dateTo=F.value,n.page=p.value,n.totalPriceRange=s.value,n.partNamesFilter=v.value,n.regionFilter=g.value,n.brandFilter=f.value,n.categoryFilter=V.value}),U(N,a=>{if(a!=null){const e=s.value[1]==y.value;T.value=0,y.value=Math.max(Math.ceil(a.data.reduce((r,x)=>Math.max(r,Number.parseFloat(x.total_price)||0),0)),y.value),(s.value[1]==0||e)&&(s.value[1]=y.value),$.value=[...new Set([...a.data.map(r=>r.nm_id),...v.value])],E.value=[...new Set([...a.data.map(r=>r.region_name),...g.value])],R.value=[...new Set([...a.data.map(r=>r.brand),...f.value])],q.value=[...new Set([...a.data.map(r=>r.category),...V.value])]}});const B=k(()=>N.value==null?[]:N.value.data.filter(a=>s.value[0]<=Number.parseFloat(a.total_price)&&Number.parseFloat(a.total_price)<=s.value[1]&&(v.value.length==0||v.value.includes(a.nm_id))&&(g.value.length==0||g.value.includes(a.region_name))&&(f.value.length==0||f.value.includes(a.brand))&&(V.value.length==0||V.value.includes(a.category)))),X=k(()=>{const a=[...new Set(B.value.map(r=>r.region_name))],e=[];for(const r of a){const x=B.value.reduce((l,A)=>(A.region_name==r?Number.parseFloat(A.total_price):0)+l,0);e.push(x)}return{labels:a,datasets:[{data:e,label:"Полная сумма по региону",backgroundColor:"rgb(255, 99, 132)"}]}});return(a,e)=>{var x;const r=de("v-date-input");return h(),D(M,null,[e[19]||(e[19]=t("h1",{class:"mb-8"},"Продажи",-1)),u(j,{class:"position-relative",height:"500"},{default:d(()=>[u(o(ne),{data:X.value,options:{responsive:!0,maintainAspectRatio:!1}},null,8,["data"])]),_:1}),u(Q,null,{default:d(()=>[u(S,{cols:"12",sm:"6"},{default:d(()=>[u(r,{label:"Начиная с даты",modelValue:o(b),"onUpdate:modelValue":e[0]||(e[0]=l=>c(b)?b.value=l:null)},null,8,["modelValue"])]),_:1}),u(S,{cols:"12",sm:"6"},{default:d(()=>[u(r,{label:"Заканчивая датой",modelValue:o(F),"onUpdate:modelValue":e[1]||(e[1]=l=>c(F)?F.value=l:null)},null,8,["modelValue"])]),_:1})]),_:1}),u(Q,null,{default:d(()=>[u(S,{cols:"12",md:"1",class:"d-flex align-center"},{default:d(()=>e[10]||(e[10]=[z("Полная сумма:")])),_:1,__:[10]}),u(S,null,{default:d(()=>[u(ve,{modelValue:s.value,"onUpdate:modelValue":e[4]||(e[4]=l=>s.value=l),max:o(y),min:o(T),step:1,class:"align-center","hide-details":""},{prepend:d(()=>[u(W,{modelValue:s.value[0],"onUpdate:modelValue":e[2]||(e[2]=l=>s.value[0]=l),density:"compact",style:{width:"100px"},type:"number",variant:"outlined","hide-details":"","single-line":""},null,8,["modelValue"])]),append:d(()=>[u(W,{modelValue:s.value[1],"onUpdate:modelValue":e[3]||(e[3]=l=>s.value[1]=l),density:"compact",style:{width:"100px"},type:"number",variant:"outlined","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1},8,["modelValue","max","min"])]),_:1})]),_:1}),o(_)!=null?(h(),ie(j,{key:0,class:"d-flex flex-column ga-4 align-center"},{default:d(()=>[e[12]||(e[12]=t("p",null,"Ошибка при загрузке данных",-1)),u(me,{onClick:o(J)},{default:d(()=>e[11]||(e[11]=[z("Попробовать ещё раз")])),_:1,__:[11]},8,["onClick"])]),_:1,__:[12]})):Y("",!0),o(_)==null?(h(),D(M,{key:1},[u(le,{"fixed-header":"",striped:"even",class:"mt-8"},{default:d(()=>[t("thead",null,[t("tr",null,[t("th",null,[u(P,{modelValue:o(v),"onUpdate:modelValue":e[5]||(e[5]=l=>c(v)?v.value=l:null),items:o($),"min-width":"200","max-width":"400",label:"Артикул",multiple:""},null,8,["modelValue","items"])]),e[13]||(e[13]=t("th",null,"ID",-1)),e[14]||(e[14]=t("th",null,"Штрих-код",-1)),e[15]||(e[15]=t("th",null,"Дата",-1)),t("th",null,[u(P,{modelValue:o(f),"onUpdate:modelValue":e[6]||(e[6]=l=>c(f)?f.value=l:null),items:o(R),"min-width":"200","max-width":"400",label:"Брэнд",multiple:""},null,8,["modelValue","items"])]),t("th",null,[u(P,{modelValue:o(V),"onUpdate:modelValue":e[7]||(e[7]=l=>c(V)?V.value=l:null),items:o(q),"min-width":"200","max-width":"400",label:"Категория",multiple:""},null,8,["modelValue","items"])]),e[16]||(e[16]=t("th",null,"Полная сумма",-1)),e[17]||(e[17]=t("th",null,"Скидка",-1)),t("th",null,[u(P,{modelValue:o(g),"onUpdate:modelValue":e[8]||(e[8]=l=>c(g)?g.value=l:null),items:o(E),"min-width":"200","max-width":"400",label:"Регион",multiple:""},null,8,["modelValue","items"])]),e[18]||(e[18]=t("th",null,"Склад",-1))])]),t("tbody",null,[(h(!0),D(M,null,pe(B.value,l=>(h(),D("tr",null,[t("td",null,m(l.nm_id),1),t("td",null,m(l.sale_id),1),t("td",null,m(l.barcode),1),t("td",null,m(l.date),1),t("td",null,m(l.brand),1),t("td",null,m(l.category),1),t("td",null,m(parseFloat(l.total_price).toFixed(2)),1),t("td",null,m(`${l.discount_percent}%`),1),t("td",null,m(l.region_name),1),t("td",null,m(l.warehouse_name),1)]))),256))])]),_:1}),t("div",Ve,[u(ge,{modelValue:o(p),"onUpdate:modelValue":e[9]||(e[9]=l=>c(p)?p.value=l:null),length:(x=o(N))==null?void 0:x.meta.last_page,density:a.$vuetify.display.smAndDown?"compact":"default","total-visible":a.$vuetify.display.smAndDown?2:5},null,8,["modelValue","length","density","total-visible"])])],64)):Y("",!0)],64)}}});export{De as default};
