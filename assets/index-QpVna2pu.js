import{a1 as ve,a3 as S,a4 as x,d as w,ab as O,a8 as X,a9 as Y,ac as C,ad as Z,ae as Ee,A as N,q as g,I as fe,g as z,p as G,af as ge,ag as we,b as $,c as o,ah as Pe,ai as Ie,h as s,n as q,z as Ae,aj as je,f as le,ak as ie,i as he,a as Be,G as P,V as xe,e as Re,al as de,am as Ue,k as He,l as Le,m as Ce,v as ze,an as Ge,w as $e,ao as qe,ap as Me,o as Je,r as Ke,t as Qe,aq as We,ar as Xe,a2 as Ye,a5 as u,a7 as V,as as d,M as Ze,_ as T,a6 as j}from"./index-D1QMmaq8.js";import{a as et,u as tt}from"./useNProgress-C_Ousk-I.js";import{u as ce,V as y,a as I,b as B,B as R,c as U}from"./VTable-D9rlYJHr.js";import{o as me}from"./list-DV3NeWJd.js";import"./VList-BxY_fzwu.js";function W(t,e,a){return et(t,-e,a)}const at=ve({__name:"PercentageChange",props:{change:{}},setup(t){return(e,a)=>(x(),S("span",{class:w({"text-red":e.change<0,"text-green":e.change>0})},[O(C((e.change*100).toFixed(0))+"% ",1),e.change>0?(x(),X(Z,{key:0,icon:"mdi-arrow-top-right"})):e.change<0?(x(),X(Z,{key:1,icon:"mdi-arrow-bottom-right"})):Y("",!0)],2))}});function ee(t){const e={};for(const a of t)a.nm_id in e?e[a.nm_id]+=1:e[a.nm_id]=1;return e}function nt(t){const e=ee(t),a=Object.keys(e).map(n=>({partName:n,count:e[n]}));return a.sort((n,m)=>m.count-n.count),a}function lt(t,e){const a=ee(t),n=ee(e),m=new Set([...Object.keys(a),...Object.keys(n)]),p=[];for(const r of m)r in a&&r in n&&p.push({partName:r,previousOrderCount:a[r],currentOrderCount:n[r],change:(n[r]-a[r])/a[r]||0});return p.sort((r,f)=>f.change-r.change),p}function te(t){const e={};for(const a of t)a.nm_id in e?e[a.nm_id]+=Number.parseFloat(a.total_price)||0:e[a.nm_id]=Number.parseFloat(a.total_price)||0;return e}function ot(t){const e=te(t),a=Object.keys(e).map(n=>({partName:n,totalPrice:e[n]}));return a.sort((n,m)=>m.totalPrice-n.totalPrice),a}function rt(t,e){const a=te(t),n=te(e),m=new Set([...Object.keys(a),...Object.keys(n)]),p=[];for(const r of m)r in a&&r in n&&p.push({partName:r,previousTotalPrice:a[r],currentTotalPrice:n[r],change:(n[r]-a[r])/a[r]||0});return p.sort((r,f)=>f.change-r.change),p}function ae(t){const e={};for(const a of t)a.is_cancel&&(a.nm_id in e?e[a.nm_id]+=1:e[a.nm_id]=1);return e}function st(t){const e=ae(t),a=Object.keys(e).map(n=>({partName:n,cancelCount:e[n]}));return a.sort((n,m)=>m.cancelCount-n.cancelCount),a}function ut(t,e){const a=ae(t),n=ae(e),m=new Set([...Object.keys(a),...Object.keys(n)]),p=[];for(const r of m)r in a&&r in n&&p.push({partName:r,previousCancelCount:a[r],currentCancelCount:n[r],change:(n[r]-a[r])/a[r]||0});return p.sort((r,f)=>f.change-r.change),p}function ne(t){const e={};for(const a of t)a.nm_id in e?(e[a.nm_id].count+=1,e[a.nm_id].discountSum+=a.discount_percent):e[a.nm_id]={count:1,discountSum:a.discount_percent};return e}function it(t){const e=ne(t),a=Object.keys(e).map(n=>({partName:n,averageDiscount:e[n].discountSum/e[n].count}));return a.sort((n,m)=>m.averageDiscount-n.averageDiscount),a}function dt(t,e){const a=ne(t),n=ne(e),m=new Set([...Object.keys(a),...Object.keys(n)]),p=[];for(const r of m)if(r in a&&r in n){const f=a[r].discountSum/a[r].count,b=n[r].discountSum/n[r].count;p.push({partName:r,previousAverageDiscount:f,currentAverageDiscount:b,change:(b-f)/f||0})}return p.sort((r,f)=>f.change-r.change),p}const ct=Ee("orderPeriodChanges",()=>{const t=N(W(new Date,7)),e=N(new Date),a=N(W(new Date,15)),n=N(W(new Date,8)),m=g(()=>me({dateFrom:t.value,dateTo:e.value,page:1,limit:500}).href),{execute:p,isFetching:r,error:f,data:b}=ce(m,{refetch:!0}).get().json(),h=g(()=>b.value==null?[]:b.value.data),D=g(()=>me({dateFrom:a.value,dateTo:n.value,page:1,limit:500}).href),{execute:F,isFetching:v,error:l,data:k}=ce(D,{refetch:!0}).get().json(),_=g(()=>k.value==null?[]:k.value.data),i=N(!1);fe(()=>{i.value=r.value||v.value});const ye=g(()=>f.value!=null||l.value!=null),ke=()=>{p(),F()},Se=g(()=>[...new Set([..._.value.map(c=>c.nm_id),...h.value.map(c=>c.nm_id)])]),M=N([]),oe=c=>M.value.length==0||M.value.includes(c.nm_id),De=g(()=>[...new Set([..._.value.map(c=>c.category),...h.value.map(c=>c.category)])]),J=N([]),re=c=>J.value.length==0||J.value.includes(c.category),Ne=g(()=>[...new Set([..._.value.map(c=>c.brand),...h.value.map(c=>c.brand)])]),K=N([]),se=c=>K.value.length==0||K.value.includes(c.brand),Oe=g(()=>[...new Set([..._.value.map(c=>c.oblast),...h.value.map(c=>c.oblast)])]),Q=N([]),ue=c=>Q.value.length==0||Q.value.includes(c.oblast),Fe=g(()=>h.value.filter(c=>oe(c)&&re(c)&&se(c)&&ue(c))),Te=g(()=>_.value.filter(c=>oe(c)&&re(c)&&se(c)&&ue(c)));return{currentPeriodDateFrom:t,currentPeriodDateTo:e,previousPeriodDateFrom:a,previousPeriodDateTo:n,isFetching:i,hasError:ye,retry:ke,currentPeriodOrders:Fe,previousPeriodOrders:Te,allPartNames:Se,partNamesFilter:M,allCategories:De,categoryFilter:J,allBrands:Ne,brandFilter:K,allRegions:Oe,regionFilter:Q}}),A=Symbol.for("vuetify:v-expansion-panel"),be=G({...le(),...je()},"VExpansionPanelText"),E=z()({name:"VExpansionPanelText",props:be(),setup(t,e){let{slots:a}=e;const n=ge(A);if(!n)throw new Error("[Vuetify] v-expansion-panel-text needs to be placed inside v-expansion-panel");const{hasContent:m,onAfterLeave:p}=we(t,n.isSelected);return $(()=>o(Ae,{onAfterLeave:p},{default:()=>{var r;return[Pe(s("div",{class:w(["v-expansion-panel-text",t.class]),style:q(t.style)},[a.default&&m.value&&s("div",{class:"v-expansion-panel-text__wrapper"},[(r=a.default)==null?void 0:r.call(a)])]),[[Ie,n.isSelected.value]])]}})),{}}}),_e=G({color:String,expandIcon:{type:de,default:"$expand"},collapseIcon:{type:de,default:"$collapse"},hideActions:Boolean,focusable:Boolean,static:Boolean,ripple:{type:[Boolean,Object],default:!1},readonly:Boolean,...le(),...Re()},"VExpansionPanelTitle"),pe=z()({name:"VExpansionPanelTitle",directives:{vRipple:ie},props:_e(),setup(t,e){let{slots:a}=e;const n=ge(A);if(!n)throw new Error("[Vuetify] v-expansion-panel-title needs to be placed inside v-expansion-panel");const{backgroundColorClasses:m,backgroundColorStyles:p}=he(()=>t.color),{dimensionStyles:r}=Be(t),f=g(()=>({collapseIcon:t.collapseIcon,disabled:n.disabled.value,expanded:n.isSelected.value,expandIcon:t.expandIcon,readonly:t.readonly})),b=P(()=>n.isSelected.value?t.collapseIcon:t.expandIcon);return $(()=>{var h;return Pe(s("button",{class:w(["v-expansion-panel-title",{"v-expansion-panel-title--active":n.isSelected.value,"v-expansion-panel-title--focusable":t.focusable,"v-expansion-panel-title--static":t.static},m.value,t.class]),style:q([p.value,r.value,t.style]),type:"button",tabindex:n.disabled.value?-1:void 0,disabled:n.disabled.value,"aria-expanded":n.isSelected.value,onClick:t.readonly?void 0:n.toggle},[s("span",{class:"v-expansion-panel-title__overlay"},null),(h=a.default)==null?void 0:h.call(a,f.value),!t.hideActions&&o(xe,{defaults:{VIcon:{icon:b.value}}},{default:()=>{var D;return[s("span",{class:"v-expansion-panel-title__icon"},[((D=a.actions)==null?void 0:D.call(a,f.value))??o(Z,null,null)])]}})]),[[ie,t.ripple]])}),{}}}),Ve=G({title:String,text:String,bgColor:String,...$e(),...Ge(),...ze(),...Ce(),..._e(),...be()},"VExpansionPanel"),H=z()({name:"VExpansionPanel",props:Ve(),emits:{"group:selected":t=>!0},setup(t,e){let{slots:a}=e;const n=Ue(t,A),{backgroundColorClasses:m,backgroundColorStyles:p}=he(()=>t.bgColor),{elevationClasses:r}=He(t),{roundedClasses:f}=Le(t),b=P(()=>(n==null?void 0:n.disabled.value)||t.disabled),h=g(()=>n.group.items.value.reduce((v,l,k)=>(n.group.selected.value.includes(l.id)&&v.push(k),v),[])),D=g(()=>{const v=n.group.items.value.findIndex(l=>l.id===n.id);return!n.isSelected.value&&h.value.some(l=>l-v===1)}),F=g(()=>{const v=n.group.items.value.findIndex(l=>l.id===n.id);return!n.isSelected.value&&h.value.some(l=>l-v===-1)});return qe(A,n),$(()=>{const v=!!(a.text||t.text),l=!!(a.title||t.title),k=pe.filterProps(t),_=E.filterProps(t);return o(t.tag,{class:w(["v-expansion-panel",{"v-expansion-panel--active":n.isSelected.value,"v-expansion-panel--before-active":D.value,"v-expansion-panel--after-active":F.value,"v-expansion-panel--disabled":b.value},f.value,m.value,t.class]),style:q([p.value,t.style])},{default:()=>[s("div",{class:w(["v-expansion-panel__shadow",...r.value])},null),o(xe,{defaults:{VExpansionPanelTitle:{...k},VExpansionPanelText:{..._}}},{default:()=>{var i;return[l&&o(pe,{key:"title"},{default:()=>[a.title?a.title():t.title]}),v&&o(E,{key:"text"},{default:()=>[a.text?a.text():t.text]}),(i=a.default)==null?void 0:i.call(a)]}})]})}),{groupItem:n}}}),mt=["default","accordion","inset","popout"],pt=G({flat:Boolean,...Xe(),...We(Ve(),["bgColor","collapseIcon","color","eager","elevation","expandIcon","focusable","hideActions","readonly","ripple","rounded","tile","static"]),...Qe(),...le(),...Ce(),variant:{type:String,default:"default",validator:t=>mt.includes(t)}},"VExpansionPanels"),L=z()({name:"VExpansionPanels",props:pt(),emits:{"update:modelValue":t=>!0},setup(t,e){let{slots:a}=e;const{next:n,prev:m}=Me(t,A),{themeClasses:p}=Je(t),r=P(()=>t.variant&&`v-expansion-panels--variant-${t.variant}`);return Ke({VExpansionPanel:{bgColor:P(()=>t.bgColor),collapseIcon:P(()=>t.collapseIcon),color:P(()=>t.color),eager:P(()=>t.eager),elevation:P(()=>t.elevation),expandIcon:P(()=>t.expandIcon),focusable:P(()=>t.focusable),hideActions:P(()=>t.hideActions),readonly:P(()=>t.readonly),ripple:P(()=>t.ripple),rounded:P(()=>t.rounded),static:P(()=>t.static)}}),$(()=>o(t.tag,{class:w(["v-expansion-panels",{"v-expansion-panels--flat":t.flat,"v-expansion-panels--tile":t.tile},p.value,r.value,t.class]),style:q(t.style)},{default:()=>{var f;return[(f=a.default)==null?void 0:f.call(a,{prev:m,next:n})]}})),{next:n,prev:m}}}),xt=ve({__name:"index",setup(t){const e=ct(),{isLoading:a}=tt();fe(()=>{a.value=e.isFetching});const n=g(()=>lt(e.previousPeriodOrders,e.currentPeriodOrders).slice(0,20)),m=g(()=>rt(e.previousPeriodOrders,e.currentPeriodOrders).slice(0,20)),p=g(()=>ut(e.previousPeriodOrders,e.currentPeriodOrders).slice(0,20)),r=g(()=>dt(e.previousPeriodOrders,e.currentPeriodOrders).slice(0,20)),f={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{display:!0,autoSkip:!1},position:"top"}}},b=g(()=>{const v=nt(e.currentPeriodOrders);return{labels:v.map(l=>l.partName),datasets:[{data:v.map(l=>l.count),label:"Количество продаж по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:v.length*20}}),h=g(()=>{const v=ot(e.currentPeriodOrders);return{labels:v.map(l=>l.partName),datasets:[{data:v.map(l=>l.totalPrice),label:"Суммарная стоимость продаж по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:v.length*20}}),D=g(()=>{const v=st(e.currentPeriodOrders);return{labels:v.map(l=>l.partName),datasets:[{data:v.map(l=>l.cancelCount),label:"Количество отмен по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:v.length*20}}),F=g(()=>{const v=it(e.currentPeriodOrders);return{labels:v.map(l=>l.partName),datasets:[{data:v.map(l=>l.averageDiscount),label:"Средняя скидка по каждому артикулу",backgroundColor:"rgb(255, 99, 132)"}],maxHeight:v.length*20}});return(v,l)=>{const k=Ye("v-date-input"),_=at;return x(),S(T,null,[l[21]||(l[21]=s("h1",{class:"mb-8"},"Главная",-1)),o(V,{class:"mb-2"},{default:u(()=>l[8]||(l[8]=[O("Текущий период:")])),_:1,__:[8]}),o(I,null,{default:u(()=>[o(y,{cols:"12",sm:"6"},{default:u(()=>[o(k,{label:"Начиная с даты",modelValue:d(e).currentPeriodDateFrom,"onUpdate:modelValue":l[0]||(l[0]=i=>d(e).currentPeriodDateFrom=i)},null,8,["modelValue"])]),_:1}),o(y,{cols:"12",sm:"6"},{default:u(()=>[o(k,{label:"Заканчивая датой",modelValue:d(e).currentPeriodDateTo,"onUpdate:modelValue":l[1]||(l[1]=i=>d(e).currentPeriodDateTo=i)},null,8,["modelValue"])]),_:1})]),_:1}),o(V,{class:"mb-2"},{default:u(()=>l[9]||(l[9]=[O("Предыдущий период:")])),_:1,__:[9]}),o(I,null,{default:u(()=>[o(y,{cols:"12",sm:"6"},{default:u(()=>[o(k,{label:"Начиная с даты",modelValue:d(e).previousPeriodDateFrom,"onUpdate:modelValue":l[2]||(l[2]=i=>d(e).previousPeriodDateFrom=i)},null,8,["modelValue"])]),_:1}),o(y,{cols:"12",sm:"6"},{default:u(()=>[o(k,{label:"Заканчивая датой",modelValue:d(e).previousPeriodDateTo,"onUpdate:modelValue":l[3]||(l[3]=i=>d(e).previousPeriodDateTo=i)},null,8,["modelValue"])]),_:1})]),_:1}),o(V,{class:"mb-2"},{default:u(()=>l[10]||(l[10]=[O("Фильтры:")])),_:1,__:[10]}),o(I,null,{default:u(()=>[o(y,{cols:"12",sm:"3"},{default:u(()=>[o(B,{modelValue:d(e).partNamesFilter,"onUpdate:modelValue":l[4]||(l[4]=i=>d(e).partNamesFilter=i),items:d(e).allPartNames,label:"Артикул",multiple:""},null,8,["modelValue","items"])]),_:1}),o(y,{cols:"12",sm:"3"},{default:u(()=>[o(B,{modelValue:d(e).categoryFilter,"onUpdate:modelValue":l[5]||(l[5]=i=>d(e).categoryFilter=i),items:d(e).allCategories,label:"Категория",multiple:""},null,8,["modelValue","items"])]),_:1}),o(y,{cols:"12",sm:"3"},{default:u(()=>[o(B,{modelValue:d(e).brandFilter,"onUpdate:modelValue":l[6]||(l[6]=i=>d(e).brandFilter=i),items:d(e).allBrands,label:"Бренд",multiple:""},null,8,["modelValue","items"])]),_:1}),o(y,{cols:"12",sm:"3"},{default:u(()=>[o(B,{modelValue:d(e).regionFilter,"onUpdate:modelValue":l[7]||(l[7]=i=>d(e).regionFilter=i),items:d(e).allRegions,label:"Регион",multiple:""},null,8,["modelValue","items"])]),_:1})]),_:1}),d(e).hasError?(x(),X(V,{key:0,class:"d-flex flex-column ga-4 align-center"},{default:u(()=>[l[12]||(l[12]=s("p",null,"Ошибка при загрузке данных",-1)),o(Ze,{onClick:d(e).retry},{default:u(()=>l[11]||(l[11]=[O("Попробовать ещё раз")])),_:1,__:[11]},8,["onClick"])]),_:1,__:[12]})):Y("",!0),d(e).hasError?Y("",!0):(x(),S(T,{key:1},[o(I,null,{default:u(()=>[o(y,{cols:"12",sm:"6",class:"position-relative"},{default:u(()=>[o(L,null,{default:u(()=>[o(H,{title:"Количество продаж по каждому артикулу"},{default:u(()=>[o(E,null,{default:u(()=>[o(V,{class:"position-relative w-100",height:d(b).maxHeight,"min-height":200},{default:u(()=>[o(d(R),{data:d(b),options:f},null,8,["data"])]),_:1},8,["height"]),o(V,{class:"my-2"},{default:u(()=>l[13]||(l[13]=[O("Топ 20 изменений по продажам:")])),_:1,__:[13]}),o(U,null,{default:u(()=>[l[14]||(l[14]=s("thead",null,[s("tr",null,[s("th",null,"Артикул"),s("th",null,"Количество продаж в предыдущем периоде"),s("th",null,"Количество продаж в текущем периоде"),s("th",null,"Процент изменения")])],-1)),s("tbody",null,[(x(!0),S(T,null,j(d(n),i=>(x(),S("tr",null,[s("td",null,C(i.partName),1),s("td",null,C(i.previousOrderCount),1),s("td",null,C(i.currentOrderCount),1),s("td",null,[o(_,{change:i.change},null,8,["change"])])]))),256))])]),_:1,__:[14]})]),_:1})]),_:1})]),_:1})]),_:1}),o(y,{cols:"12",sm:"6",class:"position-relative"},{default:u(()=>[o(L,null,{default:u(()=>[o(H,{title:"Суммарная стоимость продаж по каждому артикулу"},{default:u(()=>[o(E,null,{default:u(()=>[o(V,{class:"position-relative w-100",height:d(h).maxHeight,"min-height":200},{default:u(()=>[o(d(R),{data:d(h),options:f},null,8,["data"])]),_:1},8,["height"]),o(V,{class:"my-2"},{default:u(()=>l[15]||(l[15]=[O(" Топ 20 изменений по суммарной стоимости продаж: ")])),_:1,__:[15]}),o(U,null,{default:u(()=>[l[16]||(l[16]=s("thead",null,[s("tr",null,[s("th",null,"Артикул"),s("th",null,"Сумма за предыдущий период"),s("th",null,"Сумма за текущий период"),s("th",null,"Процент изменения")])],-1)),s("tbody",null,[(x(!0),S(T,null,j(d(m),i=>(x(),S("tr",null,[s("td",null,C(i.partName),1),s("td",null,C(i.previousTotalPrice.toFixed(2)),1),s("td",null,C(i.currentTotalPrice.toFixed(2)),1),s("td",null,[o(_,{change:i.change},null,8,["change"])])]))),256))])]),_:1,__:[16]})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),o(I,null,{default:u(()=>[o(y,{cols:"12",sm:"6",class:"position-relative"},{default:u(()=>[o(L,null,{default:u(()=>[o(H,{title:"Количество отмен по каждому артикулу"},{default:u(()=>[o(E,null,{default:u(()=>[o(V,{class:"position-relative w-100",height:d(D).maxHeight,"min-height":200},{default:u(()=>[o(d(R),{data:d(D),options:f},null,8,["data"])]),_:1},8,["height"]),o(V,{class:"my-2"},{default:u(()=>l[17]||(l[17]=[O(" Топ 20 изменений по количеству отмен: ")])),_:1,__:[17]}),o(U,null,{default:u(()=>[l[18]||(l[18]=s("thead",null,[s("tr",null,[s("th",null,"Артикул"),s("th",null,"Отмен за предыдущий период"),s("th",null,"Отмен за текущий период"),s("th",null,"Процент изменения")])],-1)),s("tbody",null,[(x(!0),S(T,null,j(d(p),i=>(x(),S("tr",null,[s("td",null,C(i.partName),1),s("td",null,C(i.previousCancelCount),1),s("td",null,C(i.currentCancelCount),1),s("td",null,[o(_,{change:i.change},null,8,["change"])])]))),256))])]),_:1,__:[18]})]),_:1})]),_:1})]),_:1})]),_:1}),o(y,{cols:"12",sm:"6",class:"position-relative"},{default:u(()=>[o(L,null,{default:u(()=>[o(H,{title:"Средняя скидка по каждому артикулу"},{default:u(()=>[o(E,null,{default:u(()=>[o(V,{class:"position-relative w-100",height:d(F).maxHeight,"min-height":200},{default:u(()=>[o(d(R),{data:d(F),options:f},null,8,["data"])]),_:1},8,["height"]),o(V,{class:"my-2"},{default:u(()=>l[19]||(l[19]=[O(" Топ 20 изменений по средней скидке: ")])),_:1,__:[19]}),o(U,null,{default:u(()=>[l[20]||(l[20]=s("thead",null,[s("tr",null,[s("th",null,"Артикул"),s("th",null,"Средняя скидка за предыдущий период"),s("th",null,"Средняя скидка за текущий период"),s("th",null,"Процент изменения")])],-1)),s("tbody",null,[(x(!0),S(T,null,j(d(r),i=>(x(),S("tr",null,[s("td",null,C(i.partName),1),s("td",null,C(i.previousAverageDiscount.toFixed(2)),1),s("td",null,C(i.currentAverageDiscount.toFixed(2)),1),s("td",null,[o(_,{change:i.change},null,8,["change"])])]))),256))])]),_:1,__:[20]})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})],64))],64)}}});export{xt as default};
